@page "/"
@using JobTracker.Models
@inject JobApplicationDB Database

<div class="main-content">
    @* Loading in status containers and population them with job applications *@
    @foreach (var container in jobStatusContainers)
    {
        <div class="status-container">
            <p>@container.Status</p>
            @foreach (var job in container.JobApplications)
            {
                <div class="job-application" draggable="true" >
                    <h4>@job.CompanyName</h4>
                    <p>@job.JobTitle</p>
                    <p>@job.DateApplied</p>
                </div>
            }
        </div>
    }
</div>


@code {
    private List<JobStatusContainer> jobStatusContainers = new();

    protected override void OnInitialized()
    {
        // Initialize containers synchronously
        jobStatusContainers = new List<JobStatusContainer>
        {
            new JobStatusContainer("Interested"),
            new JobStatusContainer("Applied"),
            new JobStatusContainer("Interview"),
            new JobStatusContainer("Offer"),
            new JobStatusContainer("Rejected")
        };

        // Fire and forget async loading
        _ = LoadJobApplicationsAsync();
    }

    private async Task LoadJobApplicationsAsync()
    {
        var allJobs = await Database.GetJobApplicationsAsync();

        foreach (var job in allJobs)
        {
            var container = jobStatusContainers.FirstOrDefault(c => c.Status == job.Status);
            if (container != null)
            {
                container.JobApplications.Add(job);
            }
        }

        // Notify the UI that data has changed
        await InvokeAsync(StateHasChanged);
    }
}